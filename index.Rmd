---
title: "Steven's corpus"
author: "Steven van Wely"
date: "February the 23nd, 2024"
output: 
  flexdashboard::flex_dashboard:
    storyboard: true
    self_contained: false
    source: https://github.com/Stevgit1/Computational-musicology-homework-7/blob/main/index.Rmd
    theme:
      heading_font:
        google: 
          family: Rajdhani
          wght: 700
      base_font:
        google: Fira Sans
      code_font:
        google: Fira Mono
      bg: "#FFFFFF"
      fg: "#212529" 
      primary: "#2b2bee"
      secondary: "#39d7b8"
      success: "#39d7b8"
      danger: "#fa5577"
      warning: "#ffb14c"
      info: "#0cc7f1"
---

```{r, echo = FALSE}
knitr::opts_chunk$set(cache = TRUE)
```

```{r, setup}
library(tidyverse)
library(ggplot2)
library(plotly)
library(spotifyr)
library(compmus)
library(ggdendro)
library(heatmaply)
library(tidymodels)
```

```{r, setup2}
# adding playlists
mellow_bars <- get_playlist_audio_features("", "37i9dQZF1DWT6MhXz0jw61")
hardcore_tracks <- get_playlist_audio_features("", "37i9dQZF1EIexrP9IBJXx5")
Techno_tracks <- get_playlist_audio_features("", "37i9dQZF1DX6J5NfMJS675")
```

### Mellow: a study

On Spotify, there are all kinds of playlists that have in some sence a connection to being considered mellow. This corpus will try to take a deeper dive into this, questioning what kind of attributes make a playlist 'mellow', an what don't. Specifiaclly, in this version, there will be taken a deeper look at to what extent the attribute 'loudness', as defined by Spotify, has an influence on different song types.
  
### Visualization 1

```{r, first visualization}
plot1 <- mellow_bars %>%
  plot_ly(x = ~loudness, hoverinfo = "text", text = ~paste("Track:", track.name, "<br>", "Playlist:", playlist_name)) %>%
  add_histogram(name = 'Mellow tracks')

plot2 <- hardcore_tracks %>%
  plot_ly(x = ~loudness, hoverinfo = "text", text = ~paste("Track:", track.name, "<br>", "Playlist:", playlist_name)) %>%
  add_histogram(name = 'Hardcore mix')

plot3 <- Techno_tracks %>%
  plot_ly(x = ~loudness, hoverinfo = "text", text = ~paste("Track:", track.name, "<br>", "Playlist:", playlist_name)) %>%
  add_histogram(name = 'Techno bunker')

subplot(plot1, plot2, plot3, nrows = 1, shareY = TRUE)%>%
  layout(title = "Loudness of different spotify playlists, captured in an histogram.")
```


***
In this plot, the 'loudness' of three different playlists, 'Mellow bars', 'Hardcore mix', and 'Techno bunker' are visualized in histograms. Looking at the chart, one might be surprised to find the loudness of hardcore tracks to be considerably lower in comparison to the Techno and mellow playlists. Additionally, the loudness of the Techno tracks and the mellow tracks seem on the same level, which is interesting.

### Conclusion and discussion
In conclusion, hardcore tracks resemble much less 'loudness' then the track types Techno and Mellow. One could however question Spotify's ability to label tracks as loud.
```{r tallis}
tallis <-
  get_tidy_audio_analysis("2J3Mmybwue0jyQ0UVMYurH") |>
  select(segments) |>
  unnest(segments) |>
  select(start, duration, pitches)
chapelle <-
  get_tidy_audio_analysis("4ccw2IcnFt1Jv9LqQCOYDi") |>
  select(segments) |>
  unnest(segments) |>
  select(start, duration, pitches)
maria_dist <-
  compmus_long_distance(
    tallis |> mutate(pitches = map(pitches, compmus_normalise, "manhattan")),
    chapelle |> mutate(pitches = map(pitches, compmus_normalise, "manhattan")),
    feature = pitches,
    method = "aitchison"
  )
```

```{r tallis-plot}
maria <-
  maria_dist |>
  mutate(
    tallis = xstart + xduration / 2,
    chapelle = ystart + yduration / 2
  ) |>
  ggplot(
    aes(
      x = tallis,
      y = chapelle,
      fill = d
    )
  ) +
  geom_tile(aes(width = xduration, height = yduration)) +
  coord_fixed() +
  scale_x_continuous(
    breaks = c(0, 60, 105, 150, 185, 220, 280, 327),
    labels =
      c(
        "Ave Maria",
        "Ave cujus conceptio",
        "Ave cujus nativitas",
        "Ave pia humilitas",
        "Ave vera virginitas",
        "Ave preclara omnibus",
        "O Mater Dei",
        ""
      ),
  ) +
  scale_y_continuous(
    breaks = c(0, 45, 80, 120, 145, 185, 240, 287),
    labels =
      c(
        "Ave Maria",
        "Ave cujus conceptio",
        "Ave cujus nativitas",
        "Ave pia humilitas",
        "Ave vera virginitas",
        "Ave preclara omnibus",
        "O Mater Dei",
        ""
      ),
  ) +
  scale_fill_viridis_c(option = "E", guide = "none") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  labs(x = "The Tallis Scholars", y = "La Chapelle Royale")
maria
```

### new chromogram

```{r pop-chroma}

ewf <-
  get_tidy_audio_analysis("3cfnGXJ9bmiWvFqEO6ff8B?si=fc8b75cc5a254be0") |>
  select(segments) |>
  unnest(segments) |>
  select(start, duration, pitches)

loveontop <-
  get_tidy_audio_analysis("1z6WtY7X4HQJvzxC4UgkSf?si=498f16c4cea74323") |>
  select(segments) |>
  unnest(segments) |>
  select(start, duration, pitches)

allineed <-
  get_tidy_audio_analysis("164VgxTozx99XCinCB9ITR?si=797ce93143424c36") |>
  select(segments) |>
  unnest(segments) |>
  select(start, duration, pitches)


```

```{r pop-chroma-plots}

ewf_plot <- 
  ewf |>
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) |>
  compmus_gather_chroma() |> 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  geom_vline(xintercept = 53, colour = "red") +
  labs(
    x = "Time (s)", 
    y = NULL, 
    fill = "Magnitude", 
    title = "After the Love Has Gone (Earth, Wind, and Fire)"
  ) +
  theme_minimal() +
  scale_fill_viridis_c() 


loveontop_plot <- 
  loveontop |>
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) |>
  compmus_gather_chroma() |> 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  geom_vline(xintercept = 184, colour = "red") +
  labs(
    x = "Time (s)", 
    y = NULL, 
    fill = "Magnitude", 
    title = "Love On Top (Beyonce)"
  ) +
  theme_minimal() +
  scale_fill_viridis_c() 


allineed_plot <- 
  allineed |>
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) |>
  compmus_gather_chroma() |> 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  geom_vline(xintercept = 137, colour = "red") +
  geom_vline(xintercept = 186, colour = "red") +
  labs(
    x = "Time (s)", 
    y = NULL, 
    fill = "Magnitude", 
    title = "All I Need (Collier, Mahalia, Ty Dolla $ign)"
  ) +
  theme_minimal() +
  scale_fill_viridis_c() 

plot_grid(ewf_plot, loveontop_plot, allineed_plot, ncol = 1)
```
***
Nice stuff

### New plot

```{r twenty-five}
circshift <- function(v, n) {
  if (n == 0) v else c(tail(v, n), head(v, -n))
}

major_key <-
  c(6.35, 2.23, 3.48, 2.33, 4.38, 4.09, 2.52, 5.19, 2.39, 3.66, 2.29, 2.88)
minor_key <-
  c(6.33, 2.68, 3.52, 5.38, 2.60, 3.53, 2.54, 4.75, 3.98, 2.69, 3.34, 3.17)
key_templates <-
  tribble(
    ~name, ~template,
    "Gb:maj", circshift(major_key, 6),
    "Bb:min", circshift(minor_key, 10),
    "Db:maj", circshift(major_key, 1),
    "F:min", circshift(minor_key, 5),
    "Ab:maj", circshift(major_key, 8),
    "C:min", circshift(minor_key, 0),
    "Eb:maj", circshift(major_key, 3),
    "G:min", circshift(minor_key, 7),
    "Bb:maj", circshift(major_key, 10),
    "D:min", circshift(minor_key, 2),
    "F:maj", circshift(major_key, 5),
    "A:min", circshift(minor_key, 9),
    "C:maj", circshift(major_key, 0),
    "E:min", circshift(minor_key, 4),
    "G:maj", circshift(major_key, 7),
    "B:min", circshift(minor_key, 11),
    "D:maj", circshift(major_key, 2),
    "F#:min", circshift(minor_key, 6),
    "A:maj", circshift(major_key, 9),
    "C#:min", circshift(minor_key, 1),
    "E:maj", circshift(major_key, 4),
    "G#:min", circshift(minor_key, 8),
    "B:maj", circshift(major_key, 11),
    "D#:min", circshift(minor_key, 3)
  )

get_tidy_audio_analysis("4EwsiiT0hwIi38gAVEEtIV") |>
  compmus_align(sections, segments) |>
  select(sections) |>
  unnest(sections) |>
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "acentre", norm = "manhattan"
      )
  ) |>
  compmus_match_pitch_template(key_templates, "aitchison", "manhattan") |>
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  geom_tile() +
  scale_fill_viridis_c(option = "E", guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "", fill = "Distance")
```
### new stuff

```{r}
track_features <-
  get_tidy_audio_analysis("3cfnGXJ9bmiWvFqEO6ff8B?si=fc8b75cc5a254be0") |>
  select(segments) |>
  unnest(segments) |>
  select(pitches)

# Initialize empty vectors to store keys and frequencies
keys <- c()
frequencies <- c()

# Iterate over each sublist in all_keys
for (key_list in track_features) {
  # Find the index of the maximum value in the sublist
  max_index <- sapply(key_list, which.max)
  
  # Append the corresponding key and frequency to the vectors
  keys <- c(keys, names(key_list)[max_index])
  frequencies <- c(frequencies, key_list[max_index])
}
#print(frequencies)
## Plot histogram
#barplot(frequencies, names.arg = keys, xlab = "Keys", ylab = "Frequency",
#        main = "Histogram of Song Keys", col = "lightblue")
```


```{r}
# Flatten the list of vectors into a single numeric vector
all_frequencies <- unlist(frequencies)

# Plot histogram
barplot(all_frequencies, names.arg = rep(keys, sapply(frequencies, length)),
        xlab = "Keys", ylab = "Frequency", main = "Histogram of Song Keys",
        col = "lightblue")

```
```{r}
# Example data
all_keys <- list(
  c(C = 0.4, `C#|Db` = 0.054, D = 0.023, `D#|Eb` = 0.1),
  c(C = 0.536, `C#|Db` = 0.07, D = 0.045, `D#|Eb` = 0.1),
  c(C = 0.567, `C#|Db` = 0.229, D = 0.037, `D#|Eb` = 0.1)
)

# Extract keys and their frequencies
keys <- sapply(all_keys, function(x) names(x)[which.max(x)])
frequencies <- sapply(all_keys, function(x) max(x))

# Plot histogram
hist(frequencies, breaks = length(unique(keys)), xlab = "Keys", ylab = "Frequency",
     main = "Histogram of Song Keys", col = "lightblue")
```


```{r}
# Example data (keys used in each group)
verse_keys <- c('C', 'G', 'D', 'A', 'E', 'B')
chorus_keys <- c('C', 'G', 'D', 'A', 'E', 'B', 'F#')
bridge_keys <- c('C', 'G', 'D', 'A', 'E')

# Combine all keys
#all_keys <- c(verse_keys, chorus_keys, bridge_keys)
all_keys <- track_features

# Plotting histograms
par(mfrow=c(1,1))
hist(as.numeric(factor(all_keys, levels = c("C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"))),
     breaks=12, col="lightblue", xlab="Key", ylab="Frequency",
     main="Histogram of Keys for Different Groups in the Song",
     xlim=c(0.5,12.5), ylim=c(0, max(table(all_keys))))

# Add bars for each group
hist(as.numeric(factor(verse_keys, levels = c("C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"))),
     breaks=12, col=rgb(0,0,1,0.5), add=TRUE)
hist(as.numeric(factor(chorus_keys, levels = c("C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"))),
     breaks=12, col=rgb(1,0,0,0.5), add=TRUE)
hist(as.numeric(factor(bridge_keys, levels = c("C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"))),
     breaks=12, col=rgb(0,1,0,0.5), add=TRUE)

# Add legend
legend("topright", legend=c("Verse", "Chorus", "Bridge"),
       fill=c(rgb(0,0,1,0.5), rgb(1,0,0,0.5), rgb(0,1,0,0.5)))

```

```{r}
europapa_url <- '0uHrMbMv3c78398pIANDqR'
graveola_url <- '6PJasPKAzNLSOzxeAH33j2'
graveola <- get_tidy_audio_analysis(europapa_url)

graveola |>
  tempogram(window_size = 8, hop_size = 1, cyclic = FALSE) |>
  ggplot(aes(x = time, y = bpm, fill = power)) +
  geom_raster() +
  scale_fill_viridis_c(guide = "none") +
  labs(x = "Time (s)", y = "Tempo (BPM)") +
  theme_classic()
```

```{r}
joost_url = '3HoBmXOKHexP12ekdvXjLY'
halloween <-
  get_playlist_audio_features("Joost Klein", joost_url) |>
  add_audio_analysis() |>
  mutate(
    segments = map2(segments, key, compmus_c_transpose),
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      ),
    timbre =
      map(
        segments,
        compmus_summarise, timbre,
        method = "mean"
      )
  ) |>
  mutate(pitches = map(pitches, compmus_normalise, "clr")) |>
  mutate_at(vars(pitches, timbre), map, bind_rows) |>
  unnest(cols = c(pitches, timbre))
```

```{r}
halloween_juice <-
  recipe(
    track.name ~
      danceability +
      energy +
      loudness +
      speechiness +
      acousticness +
      instrumentalness +
      liveness +
      valence +
      tempo +
      duration +
      C + `C#|Db` + D + `D#|Eb` +
      E + `F` + `F#|Gb` + G +
      `G#|Ab` + A + `A#|Bb` + B +
      c01 + c02 + c03 + c04 + c05 + c06 +
      c07 + c08 + c09 + c10 + c11 + c12,
    data = halloween
  ) |>
  step_center(all_predictors()) |>
  step_scale(all_predictors()) |> 
  # step_range(all_predictors()) |> 
  prep(halloween |> mutate(track.name = str_trunc(track.name, 20))) |>
  juice() |>
  column_to_rownames("track.name")
```

```{r}
halloween_dist <- dist(halloween_juice, method = "euclidean")

halloween_dist |> 
  hclust(method = "single") |> # Try single, average, and complete.
  dendro_data() |>
  ggdendrogram()
```

```{r}
heatmaply(
  halloween_juice,
  hclustfun = hclust,
  hclust_method = "average",  # Change for single, average, or complete linkage.
  dist_method = "euclidean"
)
```

