---
title: "Mellow: a story"
author: "Steven van Wely"
date: "April the 2nd, 2024"
output: 
  flexdashboard::flex_dashboard:
    storyboard: true
    self_contained: false
    source: https://github.com/Stevgit1/Computational-musicology-homework-7/blob/main/index.Rmd
    theme:
      heading_font:
        google: 
          family: Rajdhani
          wght: 700
      base_font:
        google: Fira Sans
      code_font:
        google: Fira Mono
      bg: "#FFFFFF"
      fg: "#212529" 
      primary: "#2b2bee"
      secondary: "#39d7b8"
      success: "#39d7b8"
      danger: "#fa5577"
      warning: "#ffb14c"
      info: "#0cc7f1"
---

```{r, echo = FALSE}
knitr::opts_chunk$set(cache = TRUE)
```

```{r, setup}
library(tidyverse)
library(ggplot2)
library(plotly)
library(spotifyr)
library(compmus)
library(ggdendro)
library(heatmaply)
library(tidymodels)
library(cowplot)
```

```{r, setup2}
# adding playlists
mellow_bars <- get_playlist_audio_features("", "37i9dQZF1DWT6MhXz0jw61")
hardcore_tracks <- get_playlist_audio_features("", "37i9dQZF1EIexrP9IBJXx5")
top100_tracks <- get_playlist_audio_features("", "37i9dQZEVXbNG2KDcFcKOF")
```

### Introduction

On Spotify, there are all kinds of playlists that have in some sense a connection to being considered mellow. This corpus will try to take a deeper dive into this, questioning what kind of attributes make a playlist 'mellow', an what don't. This will be done with the use of three different datasets with musical infromation. These will consists of a mellow playlist, a hardcore playlist, and the playlist for the top 100 songs in the world at the moment. Next, the features and measurement of the playlists will be studied using histograms for loudness and valence, Chromagrams, tempograms, and a from of clustering. After the analysis, there will be a conclusion section.
  
### Loudness of different styles

```{r, loudness visualisation}
plot1 <- mellow_bars %>%
  plot_ly(x = ~loudness, hoverinfo = "text", text = ~paste("Track:", track.name, "<br>", "Playlist:", playlist_name)) %>%
  add_histogram(name = 'Mellow tracks')

plot2 <- hardcore_tracks %>%
  plot_ly(x = ~loudness, hoverinfo = "text", text = ~paste("Track:", track.name, "<br>", "Playlist:", playlist_name)) %>%
  add_histogram(name = 'Hardcore mix')

plot3 <- top100_tracks %>%
  plot_ly(x = ~loudness, hoverinfo = "text", text = ~paste("Track:", track.name, "<br>", "Playlist:", playlist_name)) %>%
  add_histogram(name = 'Top Songs- Global')

subplot(plot1, plot2, plot3, nrows = 1, shareY = TRUE)%>%
  layout(title = "Loudness of different spotify playlists, captured in an histogram.",
    xaxis = list(title = "Loudness (db)"),
    yaxis = list(title = "Frequency"))
```


***
In this plot, the 'loudness' of three different playlists, 'Mellow bars', 'Hardcore mix', and 'top 100 world' are visualized in histograms. Looking at the chart, one might be surprised to find the loudness of hardcore tracks to be considerably lower in comparison to the Techno and mellow playlists. Additionally, the loudness of the Techno tracks and the mellow tracks seem on the same level, which is interesting.

### Valence of different styles

```{r, valence visualisation}
plot1 <- mellow_bars %>%
  plot_ly(x = ~valence, hoverinfo = "text", text = ~paste("Track:", track.name, "<br>", "Playlist:", playlist_name)) %>%
  add_histogram(name = 'Mellow tracks')

plot2 <- hardcore_tracks %>%
  plot_ly(x = ~valence, hoverinfo = "text", text = ~paste("Track:", track.name, "<br>", "Playlist:", playlist_name)) %>%
  add_histogram(name = 'Hardcore mix')

plot3 <- top100_tracks %>%
  plot_ly(x = ~valence, hoverinfo = "text", text = ~paste("Track:", track.name, "<br>", "Playlist:", playlist_name)) %>%
  add_histogram(name = 'Top Songs- Global')

subplot(plot1, plot2, plot3, nrows = 1, shareY = TRUE)%>%
  layout(title = "Valence of different spotify playlists, captured in an histogram.",
    xaxis = list(title = "Valence (0-1)"),
    yaxis = list(title = "Frequency"))
```

***
In this plot, the 'Valence' of three different playlists, 'Mellow bars', 'Hardcore mix', and 'top 100 world' are visualized in histograms. A notable insight can be gathered when comparing the plot for mellow tracks and the plot for hardcore tracks. In the plot for mellow tracks, there seems much more tracks with a relatively high valance, in comparison to the hardcore tracks, which have relatively low valence.

### Chromagrams

```{r}
circshift <- function(v, n) {
  if (n == 0) v else c(tail(v, n), head(v, -n))
}

major_key <-
  c(6.35, 2.23, 3.48, 2.33, 4.38, 4.09, 2.52, 5.19, 2.39, 3.66, 2.29, 2.88)
minor_key <-
  c(6.33, 2.68, 3.52, 5.38, 2.60, 3.53, 2.54, 4.75, 3.98, 2.69, 3.34, 3.17)
key_templates <-
  tribble(
    ~name, ~template,
    "Gb:maj", circshift(major_key, 6),
    "Bb:min", circshift(minor_key, 10),
    "Db:maj", circshift(major_key, 1),
    "F:min", circshift(minor_key, 5),
    "Ab:maj", circshift(major_key, 8),
    "C:min", circshift(minor_key, 0),
    "Eb:maj", circshift(major_key, 3),
    "G:min", circshift(minor_key, 7),
    "Bb:maj", circshift(major_key, 10),
    "D:min", circshift(minor_key, 2),
    "F:maj", circshift(major_key, 5),
    "A:min", circshift(minor_key, 9),
    "C:maj", circshift(major_key, 0),
    "E:min", circshift(minor_key, 4),
    "G:maj", circshift(major_key, 7),
    "B:min", circshift(minor_key, 11),
    "D:maj", circshift(major_key, 2),
    "F#:min", circshift(minor_key, 6),
    "A:maj", circshift(major_key, 9),
    "C#:min", circshift(minor_key, 1),
    "E:maj", circshift(major_key, 4),
    "G#:min", circshift(minor_key, 8),
    "B:maj", circshift(major_key, 11),
    "D#:min", circshift(minor_key, 3)
  )

create_chromagram <- function(audio_analysis, key_templates) {
  audio_analysis %>%
    compmus_align(sections, segments) %>%
    select(sections) %>%
    unnest(sections) %>%
    mutate(
      pitches = map(segments,
                     compmus_summarise, pitches,
                     method = "acentre", norm = "manhattan")
    ) %>%
    compmus_match_pitch_template(key_templates, "aitchison", "manhattan") 
}

list_of_audio_analyses <- list(
  get_tidy_audio_analysis("6tNQ70jh4OwmPGpYy6R2o9"),
  get_tidy_audio_analysis("51ZQ1vr10ffzbwIjDCwqm4"),
  get_tidy_audio_analysis("3qhlB30KknSejmIvZZLjOD"),

  get_tidy_audio_analysis("0uHrMbMv3c78398pIANDqR"),
  get_tidy_audio_analysis("272RmS2rS59JVBhlSR0cMv"),
  get_tidy_audio_analysis("4nOOoo9OJbgnTBNHe5b6nD"),

  get_tidy_audio_analysis("1ULyVVWV7PjtOfGM1UspG7"),
  get_tidy_audio_analysis("1fbgXK7wcdKu42CI5l0dTP"),
  get_tidy_audio_analysis("0w8xLwXp9WDrlPxyWofCUS")
)

song_names <- c("Benson Boone - Beautiful things",
                "Ariana Grande - We cant be friends",
                "Djo - End of beginning",

                "Josot Klein - Europapa",
                "Rachel Wallace - Tell me why",
                "Brutalismus 3000 - Romantica",

                "IDK - DENiM",
                "TOBi - Someone I Knew",
                "Russ - In the dirt")
# Create chromagrams for each song
chromagrams <- lapply(seq_along(list_of_audio_analyses), function(i) {
  create_chromagram(list_of_audio_analyses[[i]], key_templates) %>%
    mutate(song_number = i, song_name = song_names[i])
})

# Combine chromagrams into one data frame
combined_chromagrams <- do.call(rbind, chromagrams)

# Create the plot
combined_plot <- ggplot(combined_chromagrams) +
  geom_tile(aes(x = start + duration / 2, width = duration, y = name, fill = d)) +
  scale_fill_viridis_c(option = "E", guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "", fill = "Distance") +
  facet_wrap(~ song_name, nrow = 3, ncol = 3) +  # Facet by song name in a 3x3 grid
  theme(strip.background = element_rect(color = "white", fill = "white"),  # Add padding around facet labels
        strip.text = element_text(size = 5, face = "bold"),  # Adjust facet label size
        strip.placement = "outside",  # Placing titles outside the plot area
        panel.spacing = unit(1, "lines"),  # Increase spacing between facets
        plot.margin = margin(0.1, 0.1, 0.1, 0.1, "cm"),  # Adjusting plot margins
        axis.text.y = element_text(size = 4.5, angle = 45, hjust = 1))  # Reduce the size of y-axis labels5 degrees

# Print the combined plot
print(combined_plot)
```

***
Chromagrams of 3 different playlists, each consiting of three songs. More specifically, each row consists of three tracks belonging to a certain playlist. The tracks for the top 10 playlist can be found in the upper row, the tracks for the hardcore playlist in the middle row, and the tracks for the mellow playlist in the last row.

### Tempogram
```{r}
# Load tempograms
library(gridExtra)
tempogram1 <- readRDS(file = "data/tempogram1.RDS")
tempogram2 <- readRDS(file = "data/tempogram2.RDS")
tempogram3 <- readRDS(file = "data/tempogram3.RDS")
tempogram4 <- readRDS(file = "data/tempogram4.RDS")
tempogram5 <- readRDS(file = "data/tempogram5.RDS")
tempogram6 <- readRDS(file = "data/tempogram6.RDS")
tempogram7 <- readRDS(file = "data/tempogram7.RDS")
tempogram8 <- readRDS(file = "data/tempogram8.RDS")
tempogram9 <- readRDS(file = "data/tempogram9.RDS")

song_names <- c("Benson Boone - Beautiful things",
                "Ariana Grande - We cant be friends",
                "Djo - End of beginning",

                "Josot Klein - Europapa",
                "Rachel Wallace - Tell me why",
                "Brutalismus 3000 - Romantica",

                "IDK - DENiM",
                "TOBi - Someone I Knew",
                 "Russ - In the dirt")


# Convert tempograms to ggplot objects and add titles
tempogram_plots <- lapply(seq_along(list(tempogram1, tempogram2, tempogram3, tempogram4, tempogram5, tempogram6, tempogram7, tempogram8, tempogram9)), function(i) {
  tempogram <- list(tempogram1, tempogram2, tempogram3, tempogram4, tempogram5, tempogram6, tempogram7, tempogram8, tempogram9)[[i]]
  ggplot(tempogram[[1]]$data, aes(x = time, y = bpm, fill = power)) +
    geom_raster() +
    scale_fill_viridis_c(guide = "none") +
    labs(x = "Time (s)", y = "Tempo (BPM)", title = paste("Track:", song_names[i])) +
    theme_classic() +
    theme(plot.title = element_text(size = 7))
})

grid.arrange(grobs = tempogram_plots, ncol = 3)

```

***
Tempograms of 3 different playlists, each consiting of three songs. More specifically, each row consists of three tracks belonging to a certain playlist. The tracks for the top 10 playlist can be found in the upper row, the tracks for the hardcore playlist in the middle row, and the tracks for the mellow playlist in the last row.

### Dendogram

```{r}
combined_tracks <- rbind(hardcore_tracks, top100_tracks, mellow_bars)
```

```{r}
halloween <-
  mellow_bars |>
  add_audio_analysis() |>
  mutate(
    segments = map2(segments, key, compmus_c_transpose),
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      ),
    timbre =
      map(
        segments,
        compmus_summarise, timbre,
        method = "mean"
      )
  ) |>
  mutate(pitches = map(pitches, compmus_normalise, "clr")) |>
  mutate_at(vars(pitches, timbre), map, bind_rows) |>
  unnest(cols = c(pitches, timbre))
```

```{r}
halloween_juice <-
  recipe(
    track.name ~
      danceability +
      energy +
      loudness +
      speechiness +
      acousticness +
      instrumentalness +
      liveness +
      valence +
      tempo +
      duration +
      C + `C#|Db` + D + `D#|Eb` +
      E + `F` + `F#|Gb` + G +
      `G#|Ab` + A + `A#|Bb` + B +
      c01 + c02 + c03 + c04 + c05 + c06 +
      c07 + c08 + c09 + c10 + c11 + c12,
    data = halloween
  ) |>
  step_center(all_predictors()) |>
  step_scale(all_predictors()) |> 
  # step_range(all_predictors()) |> 
  prep(halloween |> mutate(track.name = str_trunc(track.name, 20))) |>
  juice() |>
  column_to_rownames("track.name")
```

```{r}
halloween_dist <- dist(halloween_juice, method = "euclidean")

halloween_dist |> 
  hclust(method = "single") |> # Try single, average, and complete.
  dendro_data() |>
  ggdendrogram()
```

***
Dendgram exploring the relations between diffrent tracks of the three used playlists combined.

### Clustering
```{r}
heatmaply(
  halloween_juice,
  hclustfun = hclust,
  hclust_method = "average",  # Change for single, average, or complete linkage.
  dist_method = "euclidean"
)
```

***

### Conclusion and discussion
